name: Build and Deploy to Play Store

on:
  # Manueller Trigger
  workflow_dispatch:
  
  # Zeitgesteuert: Jeden 1. Januar und 1. Juli um Mitternacht UTC
  schedule:
    - cron: '0 0 1 1,7 *'
  
  # Optional: Bei Tags
  push:
    tags:
      - 'v*'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/release.keystore
        
      - name: Bump version
        run: |
          # Lese aktuelle versionCode und versionName aus build.gradle
          CURRENT_VERSION_CODE=$(grep "versionCode" app/build.gradle | awk '{print $2}')
          CURRENT_VERSION_NAME=$(grep "versionName" app/build.gradle | awk '{print $2}' | tr -d '"')
          
          # Erhöhe versionCode um 1
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))
          
          # Erhöhe minor version (z.B. 1.0 -> 1.1)
          MAJOR=$(echo $CURRENT_VERSION_NAME | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION_NAME | cut -d. -f2)
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION_NAME="${MAJOR}.${NEW_MINOR}"
          
          # Aktualisiere build.gradle
          sed -i "s/versionCode $CURRENT_VERSION_CODE/versionCode $NEW_VERSION_CODE/" app/build.gradle
          sed -i "s/versionName \"$CURRENT_VERSION_NAME\"/versionName \"$NEW_VERSION_NAME\"/" app/build.gradle
          
          echo "Updated to versionCode: $NEW_VERSION_CODE, versionName: $NEW_VERSION_NAME"
          
      - name: Build Release AAB
        run: ./gradlew bundleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          
      - name: Sign AAB
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore app/release.keystore \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.KEY_PASSWORD }} \
            app/build/outputs/bundle/release/app-release.aab \
            ${{ secrets.KEY_ALIAS }}
            
      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
          packageName: rocks.wiedemann.motqot
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          
      - name: Commit version bump
        if: github.event_name == 'schedule'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add app/build.gradle
          git commit -m "chore: bump version [skip ci]"
          git push
